version: "3.9"

services:
  mysql:
    image: mysql:8.0
    container_name: api-sentinel-mysql
    command: [
      "--default-authentication-plugin=mysql_native_password",
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_0900_ai_ci"
    ]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    ports:
      - "3307:3306"
    volumes:
      # 数据持久化：重启不丢
      - mysql_data:/var/lib/mysql
      # 首次启动自动执行：建库建表
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - sentinel_net

  demo-api:
    build:
      context: .
      dockerfile: demo-api/Dockerfile
    container_name: api-sentinel-demo-api
    environment:
      TZ: Asia/Shanghai
      SERVER_PORT: 8081
    ports:
      - "8081:8081"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - sentinel_net

  sentinel-app:
    build:
      context: .
      dockerfile: sentinel-app/Dockerfile
    container_name: api-sentinel-app
    environment:
      SPRING_PROFILES_ACTIVE: docker
      TZ: Asia/Shanghai
      SERVER_PORT: 8080

      # DB
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}

      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      MAIL_FROM: ${MAIL_FROM}
      MAIL_TO: ${MAIL_TO}
      # OTel
      OTEL_SERVICE_NAME: sentinel-app
      # 指向 Alloy 的 OTLP 接收端口
      OTEL_EXPORTER_OTLP_ENDPOINT: http://alloy:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_TRACES_EXPORTER: otlp
      JAVA_TOOL_OPTIONS: "-javaagent:/app/opentelemetry-javaagent.jar"
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy
      demo-api:
        condition: service_started
    networks:
      - sentinel_net

  mailhog:
    image: mailhog/mailhog:latest
    container_name: api-sentinel-mailhog
    ports:
      - "8025:8025"   # Web UI
      - "1025:1025"   # SMTP
    networks:
      - sentinel_net

  redis:
      image: redis:7-alpine
      container_name: api-sentinel-redis
      ports:
        - "6379:6379"
      networks:
        - sentinel_net
      healthcheck:
        test: ["CMD","redis-cli","ping"]
        interval: 5s
        timeout: 3s
        retries: 10

  prometheus:
    image: prom/prometheus:latest
    container_name: api-sentinel-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--enable-feature=exemplar-storage'
      # 增加保留时间，防止撑爆硬盘
      - '--storage.tsdb.retention.time=15d'
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - sentinel_net


  grafana:
    image: grafana/grafana:latest
    container_name: api-sentinel-grafana
    ports:
      - "3000:3000"
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - sentinel_net

  loki:
    image: grafana/loki:2.9.8
    container_name: api-sentinel-loki
    command: [ "-config.file=/etc/loki/loki.yml" ]
    volumes:
      - ./observability/loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/loki
    ports:
      - "3100:3100"
    networks: [ sentinel_net ]

  tempo:
    image: grafana/tempo:2.4.2
    container_name: api-sentinel-tempo
    command: [ "-config.file=/etc/tempo/tempo.yml" ]
    volumes:
      - ./observability/tempo/tempo.yml:/etc/tempo/tempo.yml:ro
    ports:
      - "3200:3200"   # tempo query
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks: [ sentinel_net ]

  alloy:
    image: grafana/alloy:latest
    container_name: api-sentinel-alloy
    command: [ "run", "/etc/alloy/config.alloy" ]
    volumes:
      - ./observability/alloy/config.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "12345:12345" # Alloy UI
      - "4319:4317"   # 对外暴露给应用的 OTLP gRPC（避免和 tempo 冲突）
      - "4320:4318"   # OTLP HTTP
    networks: [ sentinel_net ]

networks:
  sentinel_net:
    driver: bridge

# 统一在底部声明，由 Docker 管理它们的存储空间
volumes:
  mysql_data:
  prometheus_data:
  loki_data:
